---
title: In-App-Purchase掉错单优化
date: 2020-06-18 12:28:29
tags:
---
### 概述
因苹果内购`AppleId`关联`用户`设计，与我们`账号`关联`用户`设计差异，还有苹果对用户信息的保护，导致我们拿到苹果`支付结果`时，不能准确锁定`用户账号`，从而错单漏单。为解决此类问题，我们需要做一些辅助功能保证`支付结果`与`用户`准确关联。

### 思路
苹果内购有同一商品交易未完成，不能重复购买的机制，可认为单一商品未完成，该商品与其对应订单是可以关联的
1. 在苹果返回交易结果前将用户、订单信息与商品关联存储，返回交易结果后，根据存储信息，将该笔交易与用户、订单关联。
2. 将用户、订单信息与交易信息关联存储。
3. 清空该笔订单信息，因为订单已转化为一笔未完成的交易。
4. 使用未完成交易信息与服务端查询订单结果。

### 具体步骤
1. 提交订单时，将`uid`、`orderId`关联存储在`SKMutablePayment`的`applicationUsername`中，将`uid`、`orderId`拼装成`订单对象`并关联`productId`存储钥匙串，拉起苹果支付。
2. 苹果返回交易更新，查看交易结果：
    - 失败：删除`productId`对应钥匙串`订单对象`
    - 成功，会有多种情况：
        1. 正常提交订单回调：将`订单对象`中的`uid`、`orderId`与交易返回的`transactionId`拼装成一个`未完成交易对象`存储钥匙串。从`SKMutablePayment`的`applicationUsername`中查询`uid`、`orderId`，如有直接提交服务器验证订单，如无则使用`未完成订单对象`中的`uid`、`orderId`提交服务器验证。
        2. 打开app有未完成订单回调：从`SKMutablePayment`的`applicationUsername`中查询`uid`、`orderId`，如有直接提交服务器验证订单，如无则根据`transactionId`钥匙串查找`未完成订单对象`，并使用其`uid`、`orderId`提交服务器验证。
3. 服务端验证：
    - 失败：清除该交易钥匙串对应数据，调用苹果交易完成。
    - 成功：删除要输出按对应`未完成交易`数据，调用苹果交易完成。  
    
 **最后附上[Demo](https://github.com/aloha-marbu/IPADemo)**
    
